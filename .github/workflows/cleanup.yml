name: Cleanup Failed CloudFormation Stack

on:
  workflow_dispatch:
    inputs:
      confirm_deletion:
        description: 'Type "DELETE" to confirm stack deletion'
        required: true
        default: ''

env:
  APPLICATION_NAME: contact-us-backend
  ENVIRONMENT_NAME: contact-us-backend-dev

jobs:
  cleanup:
    name: Delete Failed Stack
    runs-on: ubuntu-latest
    
    steps:
    - name: Validate confirmation
      run: |
        if [ "${{ github.event.inputs.confirm_deletion }}" != "DELETE" ]; then
          echo "‚ùå Confirmation failed. You must type 'DELETE' to proceed."
          exit 1
        fi
        echo "‚úÖ Confirmation received"

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}

    - name: Delete Elastic Beanstalk Environment and Application
      run: |
        APPLICATION_NAME="${{ env.APPLICATION_NAME }}"
        ENVIRONMENT_NAME="${{ env.ENVIRONMENT_NAME }}"
        
        # Check if environment exists
        ENV_STATUS=$(aws elasticbeanstalk describe-environments \
          --environment-names $ENVIRONMENT_NAME \
          --query 'Environments[0].Status' \
          --output text 2>/dev/null || echo "NotFound")
        
        if [ "$ENV_STATUS" != "NotFound" ]; then
          echo "üóëÔ∏è Deleting Elastic Beanstalk environment: $ENVIRONMENT_NAME"
          aws elasticbeanstalk terminate-environment --environment-name $ENVIRONMENT_NAME
          
          echo "‚è≥ Waiting for environment termination to complete..."
          aws elasticbeanstalk wait environment-terminated --environment-names $ENVIRONMENT_NAME
          
          echo "‚úÖ Environment deleted successfully!"
        else
          echo "üìù Environment $ENVIRONMENT_NAME does not exist."
        fi
        
        # Check if application exists
        if aws elasticbeanstalk describe-applications --application-names $APPLICATION_NAME 2>/dev/null | grep -q $APPLICATION_NAME; then
          echo "ÔøΩÔ∏è Deleting Elastic Beanstalk application: $APPLICATION_NAME"
          aws elasticbeanstalk delete-application --application-name $APPLICATION_NAME
          echo "‚úÖ Application deleted successfully!"
        else
          echo "üìù Application $APPLICATION_NAME does not exist."
        fi
        
        # Also clean up any CloudFormation stack if it exists
        STACK_NAME="${{ env.APPLICATION_NAME }}-stack"
        STACK_STATUS=$(aws cloudformation describe-stacks --stack-name $STACK_NAME --query 'Stacks[0].StackStatus' --output text 2>/dev/null || echo "DOES_NOT_EXIST")
        
        if [ "$STACK_STATUS" != "DOES_NOT_EXIST" ]; then
          echo "üóëÔ∏è Also deleting CloudFormation stack: $STACK_NAME"
          aws cloudformation delete-stack --stack-name $STACK_NAME
          echo "‚è≥ Waiting for stack deletion to complete..."
          aws cloudformation wait stack-delete-complete --stack-name $STACK_NAME
          echo "‚úÖ CloudFormation stack deleted successfully!"
        fi

    - name: Verify Deletion
      run: |
        APPLICATION_NAME="${{ env.APPLICATION_NAME }}"
        ENVIRONMENT_NAME="${{ env.ENVIRONMENT_NAME }}"
        
        # Check environment
        ENV_STATUS=$(aws elasticbeanstalk describe-environments \
          --environment-names $ENVIRONMENT_NAME \
          --query 'Environments[0].Status' \
          --output text 2>/dev/null || echo "NotFound")
        
        if [ "$ENV_STATUS" = "NotFound" ]; then
          echo "‚úÖ Confirmed: Environment has been successfully deleted"
        else
          echo "‚ùå Warning: Environment still exists with status: $ENV_STATUS"
        fi
        
        # Check application
        if aws elasticbeanstalk describe-applications --application-names $APPLICATION_NAME 2>/dev/null | grep -q $APPLICATION_NAME; then
          echo "‚ùå Warning: Application still exists"
        else
          echo "‚úÖ Confirmed: Application has been successfully deleted"
        fi
